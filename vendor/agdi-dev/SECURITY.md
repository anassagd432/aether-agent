# Security Policy

## Reporting Vulnerabilities

If you find a security vulnerability, **do not open a public issue**. Email us or report privately:

- **Email:** security@agdi-dev.vercel.app
- **Discord:** DM a maintainer on [Discord](https://discord.gg/pPkZ93Yb)
- **Response time:** 48 hours

---

## Security Architecture

Agdi has security layers in both the **CLI** and **Web** platforms:

### CLI Security Stack

| Layer | Module | Purpose |
|-------|--------|---------|
| **Code Firewall** | `packages/cli/src/security/code-firewall.ts` | Scans all AI-generated code before writing. Detects: `eval()`, prototype pollution, shell injection, regex DoS, hardcoded secrets (GitHub tokens, AWS keys, Supabase keys, Vercel tokens, Railway tokens, Anthropic tokens, Stripe keys) |
| **Permission Gate** | `packages/cli/src/security/permission-gate.ts` | Zero-trust model — every shell command and file write requires explicit user approval |
| **Command Guard** | `packages/cli/src/security/command-guard.ts` | Classifies commands by risk level (safe / moderate / high / critical). Blocks dangerous patterns like `rm -rf /`, `curl | sh`, `chmod 777` |
| **Rules Engine** | `packages/cli/src/security/rules-engine.ts` | Configurable security rules with severity levels and auto-remediation |
| **Workspace Trust** | `packages/cli/src/security/workspace-trust.ts` | Workspaces must be explicitly trusted. Blocks execution in dangerous directories (home, system, root) |
| **Audit Logger** | `packages/cli/src/security/audit-logger.ts` | Logs every operation to `~/.agdi/audit.log` with timestamps, action type, and outcome |
| **Shell Wrapper Detector** | `packages/cli/src/security/shell-wrapper-detector.ts` | Detects shell injection wrappers and multi-stage command chains |
| **Execution Environment** | `packages/cli/src/security/execution-env.ts` | Sandboxed execution context with env isolation |
| **Argv Parser** | `packages/cli/src/security/argv-parser.ts` | Safe argument parsing — prevents injection via command-line args |

### Web Security Stack

| Layer | Implementation | Purpose |
|-------|---------------|---------|
| **Content Security Policy** | `vercel.json`, `index.html` | Strict CSP — no `eval()`, explicit domain allowlists for scripts, styles, fonts, and connections |
| **HSTS** | `vercel.json` | HTTP Strict Transport Security with 2-year max-age and preload |
| **CORS** | `api/generate.ts` | API locked to production origin (`ALLOWED_ORIGIN`). No wildcard `*`. |
| **COOP / COEP** | `vercel.json` | Cross-Origin isolation headers |
| **Permissions Policy** | `vercel.json` | Restricts camera, geolocation, payment, USB, gyroscope, magnetometer |
| **Input Sanitization** | `lib/security/sanitize.ts` | Strips HTML tags, `javascript:` URIs, event handlers, null bytes from all user input |
| **Permission Manager** | `lib/security/permission-manager.ts` | Runtime permission prompts for file access, network access, and command execution |
| **Risk Classifier** | `lib/security/risk-classifier.ts` | Classifies operations by risk level for permission decisions |
| **Rules Engine** | `lib/security/rules-engine.ts` | Client-side security rules enforcement |
| **Audit Logger** | `lib/security/audit-logger.ts` | Client-side operation logging |
| **JWT Auth** | `api/generate.ts` | Server-side Supabase token verification; email confirmation required |
| **Rate Limiting** | `api/generate.ts`, `lib/security/sanitize.ts` | Per-user daily/monthly request limits based on plan tier |
| **API Key Masking** | `lib/security/sanitize.ts` | Client-side key masking for display |
| **Password Validation** | `components/AuthPage.tsx` | Minimum 8 chars, uppercase, lowercase, digit required |
| **Email Validation** | `components/AuthPage.tsx`, `lib/security/sanitize.ts` | RFC-compliant email format validation |

---

## Code Firewall Details

The Code Firewall (`code-firewall.ts`, 13.7KB) scans every file generated by AI agents for:

| Category | What It Catches |
|----------|----------------|
| **Dangerous APIs** | `eval()`, `Function()`, `setTimeout/setInterval` with strings, `document.write()` |
| **Injection** | Shell injection (`child_process.exec` with unsanitized input), SQL injection patterns |
| **Prototype Pollution** | `__proto__`, `constructor.prototype` manipulation |
| **Secrets** | Hardcoded API keys for GitHub, AWS, Supabase, Vercel, Railway, Stripe, Anthropic, OpenAI |
| **Network** | Suspicious external HTTP requests, data exfiltration patterns |
| **File System** | Path traversal (`../`), writing to system directories |
| **Regex DoS** | Catastrophic backtracking patterns (ReDoS) |

If a scan fails, the agent is **stopped** and the user is shown the violations before any code is written to disk.

---

## Permission Model

### CLI (Zero-Trust)

Every potentially dangerous operation requires explicit user approval:

```
⚠️  PERMISSION REQUIRED
   Action: Execute shell command
   Command: npm install express
   Risk Level: MODERATE
   [A]pprove  [D]eny  [S]kip
```

All decisions are logged to `~/.agdi/audit.log`.

### Web (Runtime Permissions)

The web app uses a `PermissionModal` component for:
- File system access (read/write via OPFS or downloads)
- Network requests to external APIs
- WebContainer command execution

---

## HTTP Security Headers (Production)

| Header | Value |
|--------|-------|
| `Strict-Transport-Security` | `max-age=63072000; includeSubDomains; preload` |
| `X-Frame-Options` | `DENY` |
| `X-Content-Type-Options` | `nosniff` |
| `Referrer-Policy` | `strict-origin-when-cross-origin` |
| `Cross-Origin-Opener-Policy` | `same-origin` |
| `Cross-Origin-Embedder-Policy` | `require-corp` |
| `Permissions-Policy` | camera=(), geolocation=(), payment=(), usb=(), gyroscope=(), magnetometer=() |
| `X-DNS-Prefetch-Control` | `off` |

---

## Best Practices

1. **Never commit** `.env` files or API keys. Use `VITE_*` prefix for client-side only.
2. **Server-side secrets** go in Vercel Environment Variables, never in the repo.
3. **Review AI output** — the Code Firewall catches common patterns, but always review generated code.
4. **Keep dependencies updated** — run `pnpm audit` regularly.
5. **Trust workspaces explicitly** — the CLI blocks execution in untrusted directories.

---

## Supported Versions

| Version | Supported |
|---------|-----------|
| 3.x (current) | ✅ Active |
| 2.x | ⚠️ Critical fixes only |
| < 2.0 | ❌ End of life |
